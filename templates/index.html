<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Konwerter Plików Material</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

</head>
<body>
    <main class="main-container">
        <section class="conversion-content">
            <form id="upload-form" class="conversion-panel card" enctype="multipart/form-data">
                <h2>Konwerter Plików</h2>
                
                <div>
                    <label for="files-input">1. Wybierz pliki (max 10MB każdy):</label>
                    <div class="controls-group">
                        <input type="file" id="files-input" name="files" multiple required hidden>
                        
                        <button class="m-button primary" id="upload-button" type="button">
                            <span class="material-icons">upload_file</span>
                            Wybierz Pliki
                        </button>
                        
                        <span id="file-name" class="file-info">Nie wybrano plików</span>
                    </div>
                </div>

                <div>
                    <label for="format">2. Konwertuj na format:</label>
                    <select id="format" name="format" class="m-select" required>
                        <option value="" disabled selected>-- Wybierz format --</option>
                        <optgroup label="Obrazy">
                            <option value="jpg">JPEG (.jpg)</option>
                            <option value="png">PNG (.png)</option>
                            <option value="bmp">BMP (.bmp)</option>
                        </optgroup>
                        <optgroup label="Wideo">
                            <option value="mp4">MP4 (.mp4)</option>
                            <option value="avi">AVI (.avi)</option>
                            <option value="mov">MOV (.mov)</option>
                            <option value="flv">FLV (.flv)</option>
                        </optgroup>
                        <optgroup label="Audio">
                            <option value="mp3">MP3 (.mp3)</option>
                            <option value="wav">WAV (.wav)</option>
                            <option value="3gp">3GP (.3gp)</option>
                            <option value="midi">MIDI (.midi)</option>
                        </optgroup>
                    </select>
                </div>

                <button type="submit" id="submit-btn" class="m-button accent" style="width: 100%;">
                    <span class="material-icons">cached</span>
                    Konwertuj
                </button>
                
                <div id="results"></div>
            </form>

            <section class="animation-section card">
                <h3>Postęp</h3>
                
                <div class="animation-placeholder" id="animation-placeholder">
                    <p>Wybierz pliki i kliknij Konwertuj, aby rozpocząć proces.</p>
                </div>
                
                <div id="progress-container" style="display: none;">
                    <p>Przetwarzanie... (To może potrwać)</p>
                    <div class="progress-section">
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
                        </div>
                        <span class="progress-text" id="progress-text-value">0%</span>
                    </div>
                </div>
                
            </section>
        </section>
    </main>

    <script>
        const fileInput = document.getElementById('files-input');
        const uploadButton = document.getElementById('upload-button');
        const fileNameSpan = document.getElementById('file-name');
        const form = document.getElementById('upload-form');
        const submitButton = document.getElementById('submit-btn');
        const progressContainer = document.getElementById('progress-container');
        const resultsDiv = document.getElementById('results');
        const animationPlaceholder = document.getElementById('animation-placeholder');
        
        // 1. Obsługa wyboru pliku
        uploadButton.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                const fileNames = Array.from(fileInput.files).map(f => f.name).join(', ');
                fileNameSpan.textContent = `Wybrano: ${fileNames}`;
                animationPlaceholder.innerHTML = `<p>Gotowy do konwersji ${fileInput.files.length} plik(i).</p>`;
            } else {
                fileNameSpan.textContent = 'Nie wybrano plików';
                animationPlaceholder.innerHTML = `<p>Wybierz pliki i kliknij Konwertuj, aby rozpocząć proces.</p>`;
            }
        });


        // 2. Obsługa wysyłki formularza
        form.addEventListener('submit', async function(e) {
            e.preventDefault(); 
            
            const formData = new FormData(form);
            
            // UI: Przygotowanie do przetwarzania
            resultsDiv.innerHTML = '';
            progressContainer.style.display = 'block';
            animationPlaceholder.style.display = 'none';
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="material-icons">hourglass_empty</span> Przetwarzanie...';

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                // Symulacja postępu
                document.getElementById('progress-bar').style.width = '50%';
                document.getElementById('progress-text-value').textContent = '50%';

                const data = await response.json();
                
                // Symulacja postępu (zakończenie)
                document.getElementById('progress-bar').style.width = '100%';
                document.getElementById('progress-text-value').textContent = '100%';

                // Wyświetlanie błędów
                if (data.errors && data.errors.length > 0) {
                    data.errors.forEach(error => {
                        const errorEl = document.createElement('div');
                        errorEl.className = 'error-item';
                        errorEl.textContent = error;
                        resultsDiv.appendChild(errorEl);
                    });
                }

                // Wyświetlanie wyników (linków do pobrania)
                if (data.results && data.results.length > 0) {
                    data.results.forEach(result => {
                        const resultEl = document.createElement('div');
                        resultEl.className = 'result-item';
                        
                        const textEl = document.createElement('span');
                        textEl.textContent = `Plik: ${result.original} → ${result.converted}`;
                        
                        const linkEl = document.createElement('a');
                        linkEl.href = result.download_url;
                        linkEl.textContent = 'Pobierz';
                        linkEl.className = 'm-button success';
                        linkEl.download = result.converted;

                        resultEl.appendChild(textEl);
                        resultEl.appendChild(linkEl);
                        resultsDiv.appendChild(resultEl);
                    });
                }
                
                // Jeśli nie ma wyników ani błędów, wskaż to
                if (data.results.length === 0 && data.errors.length === 0) {
                    resultsDiv.innerHTML = '<div class="error-item">Serwer zwrócił puste dane. Konwersja mogła się nie udać.</div>';
                }

            } catch (error) {
                console.error('Błąd sieciowy lub parsowania:', error);
                resultsDiv.innerHTML = '<div class="error-item">Wystąpił krytyczny błąd sieciowy lub błąd serwera. Sprawdź konsolę.</div>';
            } finally {
                // UI: Przywracanie stanu początkowego
                progressContainer.style.display = 'none';
                animationPlaceholder.style.display = 'flex';
                submitButton.disabled = false;
                submitButton.innerHTML = '<span class="material-icons">cached</span> Konwertuj';
                document.getElementById('progress-bar').style.width = '0%';
                document.getElementById('progress-text-value').textContent = '0%';
                animationPlaceholder.innerHTML = `<p>Proces zakończony.</p>`;
            }
        });
    </script>
</body>
</html>